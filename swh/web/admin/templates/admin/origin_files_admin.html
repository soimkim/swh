{% extends "admin/base_site.html" %}
{% load static %}

{% comment %}
Copyright (C) 2024-2025  The Software Heritage developers
See the AUTHORS file at the top-level directory of this distribution
License: GNU Affero General Public License version 3, or any later version
See top-level LICENSE file for more information
{% endcomment %}

{% block title %}Origin Files Administration{% endblock %}

{% block extrastyle %}
  {{ block.super }}
  <style>
    .origin-files-container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
    }
    
    .search-form {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    
    .search-form input[type="text"] {
      width: 70%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .search-form button {
      padding: 8px 16px;
      background: #007cba;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-left: 10px;
    }
    
    .search-form button:hover {
      background: #005a87;
    }
    
    .origin-info {
      background: #e7f3ff;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    
    .origin-info h3 {
      margin: 0 0 10px 0;
      color: #007cba;
    }
    
    .origin-info p {
      margin: 5px 0;
    }
    
    .files-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    .files-table th,
    .files-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    .files-table th {
      background-color: #f8f9fa;
      font-weight: bold;
    }
    
    .files-table tr:hover {
      background-color: #f5f5f5;
    }
    
    .swhid-cell {
      font-family: monospace;
      font-size: 12px;
      max-width: 300px;
      word-break: break-all;
    }
    
    .pagination {
      margin-top: 20px;
      text-align: center;
    }
    
    .pagination a,
    .pagination span {
      display: inline-block;
      padding: 8px 12px;
      margin: 0 4px;
      text-decoration: none;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .pagination a:hover {
      background-color: #f5f5f5;
    }
    
    .pagination .current {
      background-color: #007cba;
      color: white;
      border-color: #007cba;
    }
    
    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    
    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .stat-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      text-align: center;
      flex: 1;
    }
    
    .stat-number {
      font-size: 24px;
      font-weight: bold;
      color: #007cba;
    }
    
    .stat-label {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
  </style>
{% endblock %}

{% block content %}
<div class="origin-files-container">
  <h1>Origin Files Administration</h1>
  
  <div class="search-form">
    <form method="get" id="search-form">
      <label for="origin_url">Origin URL:</label>
      <input type="text" 
             id="origin_url" 
             name="origin_url" 
             value="{{ origin_url }}" 
             placeholder="Enter origin URL (e.g., https://github.com/user/repo)"
             required>
      <button type="submit">Search Files</button>
    </form>
  </div>
  
  {% if error %}
    <div class="error">
      <strong>Error:</strong> {{ error }}
    </div>
  {% endif %}
  
  {% if origin_info %}
    <div class="origin-info">
      <h3>Origin Information</h3>
      <p><strong>URL:</strong> {{ origin_info.url }}</p>
      <p><strong>Type:</strong> {{ origin_info.type }}</p>
      <p><strong>Visit Types:</strong> {{ origin_info.visit_types|join:", " }}</p>
      {% if origin_info.last_visit_date %}
        <p><strong>Last Visit:</strong> {{ origin_info.last_visit_date }}</p>
      {% endif %}
    </div>
    
    {% if save_requests %}
      <div class="stats">
        <div class="stat-item">
          <div class="stat-number">{{ save_requests.count }}</div>
          <div class="stat-label">Save Requests</div>
        </div>
        {% if snapshot_context %}
          <div class="stat-item">
            <div class="stat-number">{{ files|length }}</div>
            <div class="stat-label">Files in Latest Snapshot</div>
          </div>
        {% endif %}
      </div>
    {% endif %}
    
    {% if snapshot_context %}
      <div class="origin-info">
        <h3>Latest Snapshot Information</h3>
        <p><strong>Snapshot ID:</strong> {{ snapshot_context.snapshot_id }}</p>
        {% if snapshot_context.visit_info %}
          <p><strong>Visit Date:</strong> {{ snapshot_context.visit_info.formatted_date }}</p>
          <p><strong>Visit Type:</strong> {{ snapshot_context.visit_info.type }}</p>
        {% endif %}
      </div>
      
      {% if files %}
        <h3>Files in Latest Snapshot</h3>
        <table class="files-table">
          <thead>
            <tr>
              <th>File Name</th>
              <th>Path</th>
              <th>SWHID</th>
              <th>SHA1 Git</th>
              <th>Size (bytes)</th>
              <th>Permissions</th>
            </tr>
          </thead>
          <tbody>
            {% for file in files %}
              <tr>
                <td>{{ file.name }}</td>
                <td>{{ file.path }}</td>
                <td class="swhid-cell">
                  <a href="/api/1/resolve/{{ file.swhid }}/" target="_blank">
                    {{ file.swhid }}
                  </a>
                </td>
                <td class="swhid-cell">{{ file.sha1_git }}</td>
                <td>{{ file.size|floatformat:0 }}</td>
                <td>{{ file.permissions }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        
        {% if pagination %}
          <div class="pagination">
            {% if pagination.has_previous %}
              <a href="?origin_url={{ origin_url }}&page={{ pagination.previous_page }}">Previous</a>
            {% endif %}
            
            <span class="current">
              Page {{ pagination.current_page }} of {{ pagination.total_pages }}
            </span>
            
            {% if pagination.has_next %}
              <a href="?origin_url={{ origin_url }}&page={{ pagination.next_page }}">Next</a>
            {% endif %}
          </div>
        {% endif %}
      {% else %}
        <p>No files found in the latest snapshot.</p>
      {% endif %}
    {% endif %}
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Add click handler for SWHID links to show resolve endpoint response
  document.querySelectorAll('.swhid-cell a').forEach(function(link) {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      var swhid = this.textContent;
      var url = this.href;
      
      // Open in new tab
      window.open(url, '_blank');
    });
  });
});
</script>
{% endblock %}
